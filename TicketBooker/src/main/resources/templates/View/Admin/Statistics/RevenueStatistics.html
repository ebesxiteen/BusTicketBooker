<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{View/Layout/AdminLayout.html}">
<head>
    <meta charset="UTF-8">
    <title>Thống Kê Doanh Thu - GreenBus</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com/3.3.1"></script>
</head>
<body class="font-sans bg-gray-50">
<div layout:fragment="content">
    
    <h1 class="text-3xl font-bold mb-6 text-emerald-700 border-b pb-2">Thống Kê Doanh Thu</h1>

    <div th:if="${stats != null}" class="container mx-auto flex justify-center items-start gap-8 p-4">
        
        <div class="form-details w-1/3 bg-white p-6 rounded-lg shadow-lg border border-gray-200">
            
            <form th:action="@{/admin/statistics/revenue}" method="get" class="space-y-4">
                <div>
                    <label for="period" class="block mb-2 text-gray-700 font-semibold">Thống Kê Theo:</label>
                    <select id="period" name="period" class="w-full p-2 border rounded shadow-sm focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition">
                        <option value="Day">Ngày</option>
                        <option value="Month">Tháng</option>
                        <option value="Year">Năm</option>
                    </select>
                </div>

                <div>
                    <label for="date" class="block mb-2 text-gray-700 font-semibold">Ngày/Tháng/Năm:</label>
                    <input type="date" id="date" name="date" class="w-full p-2 border rounded shadow-sm focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition" th:value="${#temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}"/>
                </div>

                <button type="submit" class="w-full px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 font-bold transition shadow-md">
                    Lấy Số Liệu
                </button>
            </form>
            
            <hr class="my-4 border-gray-200">

            <div class="space-y-2 text-gray-800">
                <p>Thống Kê Theo: <span class="font-semibold text-emerald-600" th:text="${stats.period}"></span></p>
                <p>Ngày Đã Chọn: <span class="font-semibold" th:text="${#temporals.format(stats.selectedDate, 'dd/MM/yyyy')}"></span></p>
                <p>Doanh Thu Kỳ Này: <span class="font-bold text-xl text-green-700" th:text="${#numbers.formatDecimal(stats.currentPeriodRevenue, 0, 'POINT', 0, 'COMMA') + ' VND'}"></span></p>
                <p>Doanh Thu Kỳ Trước: <span class="font-bold text-xl text-red-600" th:text="${#numbers.formatDecimal(stats.previousPeriodRevenue, 0, 'POINT', 0, 'COMMA') + ' VND'}"></span></p>
            </div>

            <div class="mt-6">
                <a th:href="@{/admin/statistics}" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-700 font-semibold transition">Trở về</a>
            </div>
        </div>

        <div class="chart-container w-1/3 bg-white p-6 rounded-lg shadow-lg border border-gray-200">
            <h3 class="font-semibold text-gray-700 mb-4">So sánh Doanh thu</h3>
            <canvas id="revenueChart"></canvas>
        </div>
    </div>

    <script th:inline="javascript">
        var currentRevenue = /*[[${stats.currentPeriodRevenue}]]*/ 0;
        var previousRevenue = /*[[${stats.previousPeriodRevenue}]]*/ 0;

        var ctx = document.getElementById('revenueChart').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Kỳ Này', 'Kỳ Trước'],
                datasets: [{
                    label: 'Doanh Thu (VND)',
                    data: [currentRevenue, previousRevenue],
                    // Đổi màu Biểu đồ: Blue/Red -> Green/Red hoặc Green/Gray
                    backgroundColor: ['rgba(16, 185, 129, 0.7)', 'rgba(255, 99, 132, 0.7)'], 
                    borderColor: ['rgba(16, 185, 129, 1)', 'rgba(255, 99, 132, 1)'],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: { beginAtZero: true, ticks: { callback: function(value) { return value.toLocaleString('vi-VN'); } } } // Format số tiền trục X
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return ' Doanh thu: ' + context.parsed.x.toLocaleString('vi-VN') + ' VND';
                            }
                        }
                    },
                    legend: { display: false } // Ẩn legend nếu chỉ có 1 dataset
                }
            }
        });
    </script>
</div>
</body>
</html>