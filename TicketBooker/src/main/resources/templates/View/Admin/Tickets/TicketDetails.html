<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{View/Layout/AdminLayout.html}">

<head>
    <meta charset="UTF-8">
    <title>Chi Tiết Vé - GreenBus</title>
</head>
<body class="bg-gray-50">
<div layout:fragment="content">
    <div class="container mx-auto p-6 max-w-5xl">

        <h1 class="text-3xl font-bold mb-6 text-emerald-700 border-b pb-2">
            <i class="fas fa-ticket-alt mr-2"></i> Chi Tiết Vé ID: <span th:text="${updateRequest.id}"></span>
        </h1>

                <div th:if="${successMessage}" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
            <span class="block sm:inline" th:text="${successMessage}"></span>
        </div>

        <div th:if="${errorMessage}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <span class="block sm:inline" th:text="${errorMessage}"></span>
        </div>

        <div class="bg-white shadow-lg rounded-lg p-6 border border-gray-200">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6" th:if="${ticket != null}">
                
                <div class="md:col-span-2">
                    <h2 class="text-xl font-semibold text-gray-800 mb-3 border-l-4 border-emerald-500 pl-3">Thông Tin Chuyến</h2>
                    <div class="space-y-2 text-gray-700">
                        <p><strong>Mã Chuyến:</strong> <span th:text="${ticket.trip.id}"></span></p>
                        <p><strong>Lộ Trình:</strong> <span th:text="|${ticket.trip.departureStation} ➝ ${ticket.trip.arrivalStation}|"></span></p>
                        <p><strong>Thời Gian Khởi Hành:</strong> <span th:text="${#temporals.format(ticket.trip.departureTime, 'HH:mm dd/MM/yyyy')}"></span></p>
                        <p><strong>Ghế:</strong> <span class="font-bold text-emerald-600" th:text="${ticket.seatCodes != null && !ticket.seatCodes.isEmpty() ? ticket.seatCodes : 'Chưa gán'}"></span></p>
                            <strong>Trạng Thái Vé:</strong> 
                            <span th:text="${updateRequest.ticketStatus}"
                                                                    th:classappend="${updateRequest.ticketStatus.name() == 'USED'
                                                  ? 'bg-green-100 text-green-700'
                                                  : (updateRequest.ticketStatus.name() == 'CANCELLED'
                                                     ? 'bg-red-100 text-red-700'
                                                     : 'bg-yellow-100 text-yellow-700')}"
                                class="px-3 py-1 rounded-full text-xs font-semibold">
                            </span>
                        </p>
                    </div>
                </div>
                
                <div class="bg-emerald-50 p-4 rounded-lg border border-emerald-200">
                    <h2 class="text-xl font-semibold text-emerald-700 mb-3">Người Đặt (Booker)</h2>
                    <p><strong>Tên:</strong> <span th:text="${ticket.booker.fullName}"></span></p>
                    <p><strong>Email:</strong> <span th:text="${ticket.booker.email}"></span></p>
                    <p><strong>Loại TK:</strong> <span th:text="${ticket.booker.provider}"></span></p>
                    <p><strong>ID Booker:</strong> <span th:text="${ticket.booker.userId}"></span></p>
                </div>
            </div>

            <hr class="my-6 border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-l-4 border-red-500 pl-3">Quản Lý Vé</h2>
            
            <form th:action="@{/admin/tickets/update}" th:object="${updateRequest}" method="post" class="space-y-4">
                
                <input type="hidden" th:field="*{id}">

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1">Tên Khách Hàng</label>
                        <input type="text" th:field="*{customerName}" required
                               class="w-full px-4 py-2 border rounded shadow-sm focus:border-emerald-500 transition">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1">Số Điện Thoại Khách</label>
                        <input type="text" th:field="*{customerPhone}" required
                               class="w-full px-4 py-2 border rounded shadow-sm focus:border-emerald-500 transition">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1">Trạng Thái Vé</label>
                        <select th:field="*{ticketStatus}" required
                                class="w-full px-4 py-2 border rounded shadow-sm focus:border-emerald-500 bg-white"
                                th:disabled="${updateRequest.ticketStatus.name() == 'USED'}">
                            <option th:each="status : ${T(com.example.ticketbooker.Util.Enum.TicketStatus).values()}"
                                    th:value="${status}" th:text="${status}"></option>
                        </select>
                    </div>
                </div>
                
                <div class="flex items-center justify-end pt-4 border-t border-gray-100 mt-6 space-x-3">
                    <a href="/admin/tickets" 
                       class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition font-semibold">
                        Quay lại
                    </a>
                    <button type="submit"
                            class="px-6 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition font-bold shadow-md">
                        <i class="fas fa-save mr-2"></i> Lưu Cập Nhật
                    </button>
                    
                    <button type="button" th:if="${updateRequest.ticketStatus.name() != 'USED'}"
                            th:attr="onclick=|confirmCancelTicket(${updateRequest.id})|"
                            class="px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition font-bold shadow-md">
                        <i class="fas fa-times-circle mr-2"></i> Hủy Vé
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
</html>

<script type="text/javascript" th:src="@{/js/TicketManagement.js}"></script>
<script>
    // Hàm JS để xác nhận và hủy vé (Cần được định nghĩa trong TicketManagement.js)
    function confirmCancelTicket(ticketId) {
        Swal.fire({
            title: 'Xác nhận hủy vé',
            text: `Bạn có chắc muốn hủy vé ID ${ticketId}? Hành động này không thể hoàn tác.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Đồng ý Hủy',
            cancelButtonText: 'Không'
        }).then((result) => {
            if (result.isConfirmed) {
                // Gọi API hủy vé (sẽ cần logic JS xử lý fetch)
                fetch(`/api/tickets/cancel-ticket`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: ticketId }) // Gửi TicketIdRequest
                })
                .then(response => {
                    if (response.ok) {
                        Swal.fire('Đã Hủy!', 'Vé đã được hủy thành công.', 'success')
                            .then(() => { window.location.reload(); });
                    } else {
                        Swal.fire('Lỗi', 'Hủy vé thất bại.', 'error');
                    }
                })
                .catch(err => Swal.fire('Lỗi', 'Lỗi kết nối hệ thống.', 'error'));
            }
        });
    }
</script>