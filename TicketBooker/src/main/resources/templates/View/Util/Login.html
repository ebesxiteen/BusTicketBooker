<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng nhập / Đăng ký - GreenBus</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/AdminLayout.css}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

    <style>
        .bg-blue-600 { background-color: #10b981 !important; }
        .hover\:bg-blue-700:hover { background-color: #059669 !important; }
        .text-blue-600 { color: #10b981 !important; }
        .outline-blue-500 { outline-color: #10b981 !important; }
        .bg-red-800 { background-color: #991b1b !important; } /* Màu thông báo lỗi */
        .shadow-img { box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.5); } /* Bóng xanh cho ảnh */
    </style>
</head>
<body class="bg-gray-100 font-montserrat">

<div class="flex h-screen font-montserrat items-center justify-center relative">
    
    <div class="login-container w-full max-w-7xl grid md:grid-cols-2 items-center h-full relative">

        <form th:action="@{/perform_login}" method="post" class="login-form max-w-lg max-md:mx-auto w-full p-6 transition-all duration-1000 transform opacity-100">
            <div class="mb-8">
                <h3 class="text-gray-800 text-4xl font-extrabold">Đăng nhập</h3>
                <p class="text-gray-800 text-sm mt-6">Truy cập tài khoản dễ dàng.</p>
            </div>

            <div class="relative flex items-center text-red-800 mb-4">
                <p><span th:text="${error}"></span></p>
            </div>
            
            <div>
                <label for="email" class="text-gray-800 text-[15px] mb-2 block">Email</label>
                <div class="relative flex items-center">
                    <input id="email" name="username" type="text" required 
                           class="login-email w-full text-sm text-gray-800 bg-gray-100 focus:bg-transparent px-4 py-3.5 rounded-md outline-green-600 border border-gray-300" placeholder="Nhập email của bạn" />
                    <i class="fas fa-envelope w-[18px] h-[18px] absolute right-4 text-gray-400"></i>
                </div>
            </div>

            <div class="mt-4">
                <label for="password" class="text-gray-800 text-[15px] mb-2 block">Mật khẩu</label>
                <div class="relative flex items-center">
                    <input id="password" name="password" type="password" required 
                           class="login-password w-full text-sm text-gray-800 bg-gray-100 focus:bg-transparent px-4 py-3.5 rounded-md outline-green-600 border border-gray-300" placeholder="Nhập mật khẩu" />
                    <i class="fas fa-lock w-[18px] h-[18px] absolute right-4 text-gray-400"></i>
                </div>
            </div>

            <div class="flex flex-wrap items-center justify-between mt-4">
                <div class="flex items-center">
                    <input id="remember-me" name="remember-me" type="checkbox" class="shrink-0 h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded" />
                    <label for="remember-me" class="ml-3 block text-sm text-gray-800">
                        Ghi nhớ
                    </label>
                </div>
                <div class="text-sm">
                    <a th:href="@{/profile/reset-password}" class="text-emerald-600 font-semibold hover:underline">
                        Quên mật khẩu?
                    </a>
                </div>
            </div>

            <div class="mt-8">
                <button type="submit" class="w-full shadow-md py-3 px-6 text-sm tracking-wide font-semibold rounded-md text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none transition">
                    Đăng nhập
                </button>
            </div>
            
            <p class="text-sm mt-8 text-center text-gray-800">Chưa có tài khoản? <a href="javascript:void(0);" class="register-here text-emerald-600 font-semibold tracking-wide hover:underline ml-1">Đăng ký tại đây</a></p>
            
            <div class="mt-4 space-y-3">
                <a th:href="@{/oauth2/authorization/facebook}" class="w-full px-5 py-2.5 flex items-center justify-center rounded-md text-white text-sm tracking-wider font-semibold border-none outline-none bg-[#4267B2] hover:bg-[#365899] transition">
                    <i class="fab fa-facebook-f mr-4 text-lg"></i> Continue with Facebook
                </a>
                <a th:href="@{/oauth2/authorization/google}" class="w-full px-5 py-2.5 flex items-center justify-center rounded-md text-gray-800 text-sm tracking-wider font-semibold border border-gray-300 bg-white hover:bg-gray-100 transition">
                    <img src="https://img.icons8.com/color/48/000000/google-logo.png" width="18" height="18" class="inline shrink-0 mr-4" alt="Google">
                    Continue with Google
                </a>
            </div>
        </form>

        <div class="login-img h-full items-center relative transition-all duration-1000 max-md:before:hidden before:absolute before:bg-emerald-600 before:h-full before:w-full before:right-0 before:z-0">
            <div class="md:mb-16 mb-8 z-10 mx-20 mt-40 relative text-white">
                <h3 class="text-4xl font-extrabold text-white">GreenBus</h3>
                <p class="text-lg mt-3">Đặt vé xe khách nhanh chóng và an toàn tuyệt đối.</p>
            </div>
        </div>

        <div class="registration-form max-w-lg max-md:mx-auto w-full p-6 transition-all opacity-0 duration-1000 absolute right-0 z-50 pointer-events-none">
            <h3 class="text-gray-800 text-4xl font-extrabold mb-8">Đăng ký</h3>
            <form id="registration-form" onsubmit="event.preventDefault(); registerUser();">
                <div class="space-y-4">
                    <input name="fullName" type="text" id="register-name" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-emerald-500" placeholder="Họ và tên" />
                    <input name="email" type="email" id="register-email" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-emerald-500" placeholder="Email" />
                    <input name="phone" type="tel" id="register-phone" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-emerald-500" placeholder="Số điện thoại" />
                    <input name="password" id="register-password" type="password" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-emerald-500" placeholder="Mật khẩu" />
                    <span id="error-announcer" class="text-sm text-red-600 block"></span>
                </div>
                
                <div class="flex items-center mt-6">
                    <input id="register-terms" name="remember-me" type="checkbox" class="h-4 w-4 shrink-0 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded" required/>
                    <label for="register-terms" class="text-gray-800 ml-3 block text-sm">
                        Tôi chấp nhận <a href="javascript:void(0);" class="text-emerald-600 font-semibold hover:underline">Điều khoản</a>
                    </label>
                </div>

                <div class="mt-6">
                    <button type="submit" id="register-submit" class="w-full py-3 px-4 text-sm tracking-wider font-semibold rounded-md text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none">
                        Tạo tài khoản
                    </button>
                </div>
                <p class="text-sm mt-4 text-center text-gray-800">Đã có tài khoản? <a href="javascript:void(0);" class="login-here text-emerald-600 font-semibold hover:underline ml-1">Đăng nhập</a></p>
            </form>
        </div>


        <div class="registration-img h-full items-center relative transition-all duration-1000 max-md:hidden absolute bg-gradient-to-r from-emerald-800 to-emerald-900 before:h-full w-full left-0 z-10 pointer-events-none">
            <div class="md:mb-16 mb-8 z-100 mx-20 mt-40 relative text-white">
                <h3 class="text-4xl font-extrabold text-white">Đăng ký dễ dàng</h3>
                <p class="text-lg mt-3">Chỉ vài bước đơn giản để bắt đầu đặt vé.</p>
            </div>
        </div>
    </div>
</div>

<script>
    // Hàm JS Đăng ký (Sửa lỗi logic)
    async function registerUser() {
        const fullName = document.querySelector("#register-name").value;
        const email = document.querySelector("#register-email").value;
        const phone = document.querySelector("#register-phone").value;
        const password = document.querySelector("#register-password").value;
        const errorAnnouncer = document.querySelector("#error-announcer");
        
        errorAnnouncer.innerHTML = ''; // Clear previous errors

        // Basic Validation
        if (!fullName || !email || !phone || !password) {
            errorAnnouncer.innerHTML = 'Vui lòng điền đầy đủ thông tin.';
            return;
        }

        // 1. Kiểm tra Email tồn tại
        try {
            const checkUrl = `/api/users/exist?email=${email}`; // Đã sửa API sang /api/users
            const response = await fetch(checkUrl);

            if (response.ok) { // Status 200 (Email Found)
                errorAnnouncer.innerHTML = 'Email đã tồn tại.';
                return;
            }
        } catch (error) {
            console.error(error);
            // Tiếp tục nếu lỗi mạng (coi như chưa tìm thấy)
        }
        
        // 2. Chuẩn bị DTO
        const addUserRequest = {
            fullName: fullName,
            email: email,
            phone: phone,
            password: password,
            role: 'USER', // Mặc định là Khách hàng
            status: 'ACTIVE'
        };

        // 3. Gửi Request Đăng ký
        try {
            const response = await fetch("/register",{
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(addUserRequest)
            });

            if (response.ok) {
                Swal.fire({
                    title: 'Thành công',
                    text: 'Đăng ký thành công! Vui lòng đăng nhập.',
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(() => {
                     document.querySelector('.login-here').click(); // Chuyển sang form Login
                });
            } else {
                Swal.fire({ title: 'Lỗi', text: 'Đăng ký thất bại do lỗi server.', icon: 'error' });
            }
        } catch (e) {
            Swal.fire({ title: 'Lỗi', text: 'Lỗi kết nối hệ thống.', icon: 'error' });
        }
    }
    
    // Hàm xử lý UI trượt qua lại giữa Login và Register
    function toggleForms() {
        const logForm = document.querySelector('.login-form');
        const logImg = document.querySelector('.login-img');
        const regForm = document.querySelector('.registration-form');
        const regImg = document.querySelector('.registration-img');
        
        logForm.classList.toggle('opacity-0');
        logForm.classList.toggle('opacity-100');

        logImg.classList.toggle('opacity-0');
        logImg.classList.toggle('opacity-100');

        regForm.classList.toggle('opacity-0');
        regForm.classList.toggle('opacity-100');
        regForm.classList.toggle('pointer-events-none');
        
        regImg.classList.toggle('opacity-0');
        regImg.classList.toggle('opacity-100');
    }

    // Gán sự kiện cho nút chuyển đổi
    document.querySelector('.register-here').addEventListener("click", toggleForms);
    document.querySelector('.login-here').addEventListener("click", toggleForms);
    document.querySelector("#register-submit").addEventListener("click", registerUser);
    
</script>

</body>
</html>