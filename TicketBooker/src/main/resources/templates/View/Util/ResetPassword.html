<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{View/Layout/UserLayout.html}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yêu cầu Đặt lại Mật khẩu - GreenBus</title>
    
    <style>
        /* Định nghĩa màu GreenBus chính */
        .text-primary-green { color: #10b981 !important; }
        .bg-primary-green { background-color: #10b981 !important; }
        .hover\:bg-primary-dark:hover { background-color: #059669 !important; }
        .focus\:ring-primary-green:focus { --tw-ring-color: #10b981 !important; }
    </style>
</head>
<body class="bg-gray-50">
<div layout:fragment="content">
    <div class="bg-white shadow-2xl rounded-xl p-8 max-w-md w-full mx-auto my-16 border border-gray-200">
        
        <h1 class="text-center text-3xl font-bold text-primary-green mb-6">Quên Mật Khẩu?</h1>
        <p class="text-center text-gray-600 mb-8">Vui lòng nhập Email và Mật khẩu mới. Chúng tôi sẽ gửi link xác nhận qua Email.</p>

        <form id="resetForm" class="space-y-6">
            
            <div>
                <label for="username" class="block text-gray-700 font-medium mb-1">Email Tài khoản</label>
                <input type="email" id="username" name="username" placeholder="Nhập email của bạn"
                       class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary-green focus:border-primary-green px-3 py-2 transition"
                       required>
            </div>
            
            <div>
                <label for="password" class="block text-gray-700 font-medium mb-1">Mật khẩu mới</label>
                <input type="password" id="password" name="password" placeholder="Nhập mật khẩu mới"
                       class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary-green focus:border-primary-green px-3 py-2 transition"
                       required>
            </div>
            
            <div>
                <label for="confirmPassword" class="block text-gray-700 font-medium mb-1">Xác nhận mật khẩu mới</label>
                <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Nhập lại mật khẩu mới"
                       class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary-green focus:border-primary-green px-3 py-2 transition"
                       required>
                <p id="error" class="text-red-600 text-sm mt-1 hidden font-medium">Passwords do not match.</p>
            </div>
            
            <div>
                <button type="button" id="submitBtn"
                    class="w-full bg-primary-green text-white py-2.5 px-4 rounded-lg shadow-md hover:bg-primary-dark disabled:opacity-50 transition duration-300">
                    <i class="fas fa-paper-plane mr-2"></i> Gửi link xác nhận
                </button>
            </div>
        </form>
    </div>

</div>
</body>
</html>

<script layout:fragment="script">
    (function () {
        document.addEventListener("DOMContentLoaded", function () {
            
            const usernameInput = document.getElementById("username"); // Đây là Email
            const passwordInput = document.getElementById("password");
            const confirmPasswordInput = document.getElementById("confirmPassword");
            const submitBtn = document.getElementById("submitBtn");
            const errorElement = document.getElementById("error");

            // Attach listeners to fields
            usernameInput.addEventListener("input", validateForm);
            passwordInput.addEventListener("input", validateForm);
            confirmPasswordInput.addEventListener("input", validateForm);
            
            // Bắt sự kiện click nút
            submitBtn.addEventListener("click", sendEmailConfirm);

            // Hàm kiểm tra form (đã sửa lỗi)
            function validateForm() {
                const isUsernameFilled = usernameInput.value.trim() !== "";
                const isPasswordFilled = passwordInput.value.trim() !== "";
                const isConfirmPasswordFilled = confirmPasswordInput.value.trim() !== "";
                const passwordsMatch = passwordInput.value === confirmPasswordInput.value;

                if (passwordInput.value.trim() && confirmPasswordInput.value.trim() && !passwordsMatch) {
                    errorElement.classList.remove("hidden");
                } else {
                    errorElement.classList.add("hidden");
                }

                // Kích hoạt nút chỉ khi tất cả đều điền và mật khẩu khớp
                submitBtn.disabled = !(isUsernameFilled && isPasswordFilled && isConfirmPasswordFilled && passwordsMatch);
            }

            // Hàm gọi API gửi email
            async function sendEmailConfirm() {
                submitBtn.disabled = true; // Khóa nút khi đang xử lý
                
                const payload = {
                    email: usernameInput.value.trim(),      // Backend API UserRepo.findByEmail
                    newPassword: passwordInput.value.trim() // Password mới (sẽ được mã hóa ở Backend)
                };
                
                try {
                    // SỬA URL: Dùng đường dẫn tương đối và endpoint chuẩn
                    const response = await fetch("/api/users/confirm-reset", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    // Server trả về true (200 OK) nếu email được gửi thành công
                    if (response.ok) {
                        const result = await response.json(); // Nhận giá trị boolean true/false
                        if (result === true) {
                            Swal.fire({
                                icon: "success",
                                title: "Thành công!",
                                text: "Đã gửi email xác nhận đến tài khoản của bạn. Vui lòng kiểm tra hộp thư!",
                                confirmButtonText: 'Đóng',
                                confirmButtonColor: '#10b981'
                            });
                        } else {
                            // Backend trả về 200 OK nhưng logic gửi email fail (result=false)
                             Swal.fire({ icon: "error", title: "Lỗi gửi email", text: "Lỗi xảy ra khi gửi email xác nhận. Vui lòng thử lại.", confirmButtonColor: '#10b981' });
                        }
                    } else if (response.status === 404) {
                        Swal.fire({ icon: "warning", title: "Không tìm thấy", text: "Email này không tồn tại trong hệ thống.", confirmButtonColor: '#10b981' });
                    }
                    else {
                        Swal.fire({ icon: "error", title: "Lỗi Server", text: "Không thể xử lý yêu cầu. Vui lòng thử lại sau.", confirmButtonColor: '#10b981' });
                    }
                } catch (error) {
                    Swal.fire({ title: "Lỗi kết nối", text: "Không thể kết nối đến máy chủ API.", icon: "error", confirmButtonColor: '#10b981' });
                } finally {
                    submitBtn.disabled = false; // Mở lại nút
                    passwordInput.value = '';
                    confirmPasswordInput.value = '';
                }
            }
        });
    }
</script>